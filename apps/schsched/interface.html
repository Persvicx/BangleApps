<html>
<head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
    <link rel="stylesheet" href="../../css/spectre-icons.min.css">
</head>

<body>
    <h4>School Schedule Editor</h4>

    <!-- Add Class Form -->
    <form id="classForm">
        <label class="label">Class Name:</label>
        <input class="form-input" id="name" type="text" required>

        <label class="label">Room:</label>
        <input class="form-input" id="room" type="text">

        <label class="label">Start Time (24h HH:MM):</label>
        <input class="form-input" id="start" type="text" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" required>

        <label class="label">End Time (24h HH:MM):</label>
        <input class="form-input" id="end" type="text" pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" required>

        <label class="label">Teacher:</label>
        <input class="form-input" id="teacher" type="text">

        <label class="label">Extra Info:</label>
        <textarea class="form-input" id="extra"></textarea>

        <br>
        <input class="btn btn-primary" type="submit" value="Add Class">
        <br><br>
    </form>

    <button class="btn btn-primary" onclick="updateDevice()">Save Schedule to Watch</button>

    <div>
        <!-- LOADING -->
        <div id="loading">
            <div class="empty">
                <div class="empty-icon">
                    <div class="loading loading-lg"></div>
                </div>
                <p class="empty-title h5">Loading</p>
                <p class="empty-subtitle">Reading schedule from watch...</p>
            </div>
        </div>

        <!-- EMPTY -->
        <div id="empty" class="d-hide">
            <div class="empty">
                <div class="empty-icon">
                    <i class="icon icon-more-horiz"></i>
                </div>
                <p class="empty-title h5">No classes yet</p>
                <p class="empty-subtitle">Use the form above to add a class</p>
            </div>
        </div>

        <!-- CLASS LIST -->
        <table id="classList" class="table table-striped table-hover"></table>
    </div>

    <script src="../../core/lib/customize.js"></script>

    <script>
        let classes = [];
        let fetching = true;

        /* ===== Load schedule from watch ===== */
        function onInit(device) {
            fetching = true;
            Util.readStorageJSON("schsched.json", (json) => {
                if (json && json.classes) classes = json.classes;
                fetching = false;
                renderList();
            });
        }

        /* ===== Add class ===== */
        document.getElementById("classForm").addEventListener("submit", (e) => {
            e.preventDefault();
            addClass();
        });

        function addClass() {
            const newClass = {
                name: document.getElementById("name").value,
                room: document.getElementById("room").value,
                start: document.getElementById("start").value,
                end: document.getElementById("end").value,
                teacher: document.getElementById("teacher").value,
                extra: document.getElementById("extra").value
            };

            classes.push(newClass);
            updateDevice();
        }

        /* ===== Save to device ===== */
        function updateDevice() {
            fetching = true;
            renderList();

            Util.writeStorage("schsched.json", JSON.stringify({ classes }), () => {
                fetching = false;
                renderList();
            });
        }

        /* ===== Delete class ===== */
        function deleteClass(i) {
            classes.splice(i, 1);
            renderList();
        }

        /* ===== Sorting (Up / Down) ===== */
        function moveUp(i) {
            if (i === 0) return;
            [classes[i], classes[i - 1]] = [classes[i - 1], classes[i]];
            renderList();
        }

        function moveDown(i) {
            if (i === classes.length - 1) return;
            [classes[i], classes[i + 1]] = [classes[i + 1], classes[i]];
            renderList();
        }

        /* ===== Show/hide empty/loading ===== */
        function toggleDisplay() {
            const empty = document.getElementById("empty");
            const loading = document.getElementById("loading");

            if (fetching) {
                loading.className = "d-block";
                empty.className = "d-hide";
            } else if (classes.length === 0) {
                empty.className = "d-block";
                loading.className = "d-hide";
            } else {
                loading.className = "d-hide";
                empty.className = "d-hide";
            }
        }

        /* ===== Render table ===== */
        function renderList() {
            toggleDisplay();

            const table = document.getElementById("classList");
            table.innerHTML = "";

            if (fetching) return;

            classes.forEach((cls, i) => {
                let tr = document.createElement("tr");

                let td = document.createElement("td");
                td.innerHTML = `
                    <b>${cls.name}</b><br>
                    Room: ${cls.room}<br>
                    ${cls.start} - ${cls.end}<br>
                    Teacher: ${cls.teacher}<br>
                    <i>${cls.extra}</i>
                `;

                let btns = document.createElement("td");

                btns.innerHTML = `
                    <button class="btn btn-sm btn-primary" onclick="moveUp(${i})">↑</button>
                    <button class="btn btn-sm btn-primary" onclick="moveDown(${i})">↓</button>
                    <button class="btn btn-sm btn-error" onclick="deleteClass(${i})">Delete</button>
                `;

                tr.appendChild(td);
                tr.appendChild(btns);
                table.appendChild(tr);
            });
        }
    </script>
</body>
</html>
